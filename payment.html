<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Affordin - Payment</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      margin: 0;
      padding: 0;
    }
    nav {
      display: flex;
      justify-content: center;
      background: #111111;
      padding: 10px 0;
    }
    nav a {
      color: #fff;
      text-decoration: none;
      margin: 0 20px;
      font-weight: 500;
      transition: color 0.3s;
    }
    nav a:hover { color: #ff3131; }

    .hero {
      background-color: #3bb371;
      color: white;
      text-align: center;
      padding: 60px 20px;
    }

    .wallet-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin-top: 30px;
    }

    .payment-info {
      display: flex;
      flex-direction: row;
      gap: 20px;
      font-size: 20px;
    }

    .wallet-address {
      font-family: monospace;
      font-size: 18px;
      word-break: break-word;
      text-align: center;
    }

    .btc-amount {
      font-weight: bold;
      font-size: 22px;
    }

    .button {
      display: inline-block;
      padding: 10px 20px;
      background-color: #ff3131;
      color: white;
      text-decoration: none;
      border-radius: 5px;
      margin-top: 5px;
    }

    #expiry-timer {
      font-weight: bold;
      margin-top: 5px;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <header>Affordin</header>

  <nav>
    <a href="yizheswebsitefordib.html">Home</a>
    <a href="about.html">About</a>
    <a href="services.html">Services</a>
    <a href="contact.html">Contact</a>
    <a href="reviews.html">Reviews</a>
  </nav>

  <section class="hero">
    <h1>Payment Page</h1>
    <p>Pay with Bitcoin before the timer expires</p>

    <div class="wallet-container" id="wallet-section">
      <div class="payment-info">
        <div class="price-info"><strong>Price: $<span id="price">0</span></strong></div>
        <div class="btc-amount">BTC to pay: <span id="btc">0</span></div>
      </div>
      <div class="wallet-address">1FfmbHfnpaZjKFvyi1okTjJJusN455paPH</div>
      <img src="fake_wallet_qr.png" alt="Bitcoin QR Code" width="200">
      <a href="fake_wallet_qr.png" class="button" download>Download QR Code</a>
      <p id="expiry-timer">Time left: </p>
    </div>
  </section>

  <script>
    const EXPIRY_KEY = 'affordin_expiry';
    const EXPIRY_DURATION = 15 * 60 * 1000; // 15 minutes

    let expirationTime = localStorage.getItem(EXPIRY_KEY);
    if (!expirationTime || isNaN(expirationTime)) {
      expirationTime = new Date().getTime() + EXPIRY_DURATION;
      localStorage.setItem(EXPIRY_KEY, expirationTime);
    } else {
      expirationTime = parseInt(expirationTime);
    }

    const timerDisplay = document.getElementById('expiry-timer');
    const walletSection = document.getElementById('wallet-section');

    const countdown = setInterval(() => {
      const now = new Date().getTime();
      const distance = expirationTime - now;

      if (distance < 0) {
        clearInterval(countdown);
        timerDisplay.textContent = "Payment expired!";
        walletSection.classList.add('hidden');
        return;
      }

      const hours = Math.floor((distance % (1000*60*60*24)) / (1000*60*60));
      const minutes = Math.floor((distance % (1000*60*60)) / (1000*60));
      const seconds = Math.floor((distance % (1000*60)) / 1000);

      timerDisplay.textContent = `Time left: ${hours}h ${minutes}m ${seconds}s`;
    }, 1000);

    // Get price from URL
    const urlParams = new URLSearchParams(window.location.search);
    const price = parseFloat(urlParams.get('price')) || 0;
    document.getElementById('price').textContent = price;

    // Fetch live BTC
    fetch('https://071d6433-ea61-404e-9e83-c8f177e7a43b-00-1cqjsstz3bnr3.picard.replit.dev/btc-price')
      .then(res => res.json())
      .then(data => {
        const btcRate = data.bitcoin.usd;
        document.getElementById('btc').textContent = (price / btcRate).toFixed(6);
      })
      .catch(err => {
        console.error('Error fetching BTC price:', err);
        alert('Failed to fetch live BTC price.');
      });

    // --- Console-triggered Payment ---
    function paymentCompleted() {
      clearInterval(countdown);
      localStorage.removeItem(EXPIRY_KEY);

      const qr = walletSection.querySelector('img');
      const button = walletSection.querySelector('.button');
      if(qr) qr.style.display = 'none';
      if(button) button.style.display = 'none';

      const message = document.createElement('p');
      message.textContent = "âœ… Payment Completed!";
      message.style.color = "#fff";
      message.style.fontWeight = "bold";
      message.style.fontSize = "22px";
      message.style.marginTop = "10px";
      walletSection.appendChild(message);

      timerDisplay.textContent = "Payment completed!";
    }

    window.paymentCompleted = paymentCompleted;
    console.log("Type triggerPayment('paid') in the console to simulate payment.");
    window.triggerPayment = function(code) {
      if(code.toLowerCase() === "paid") paymentCompleted();
      else console.warn("Wrong code. Type 'paid' to trigger payment.");
    };

    // Optional: Dev tool to reset timer manually
    window.resetTimer = function() {
      localStorage.removeItem(EXPIRY_KEY);
      location.reload();
    };
  </script>

  <footer>
    &copy; 2025 Affordin, Yizhe Su. All Rights Reserved. Do Not Copy.
  </footer>
</body>
</html>
